= Ticket Booth
:doctype: book
:source-highlighter: rouge
:rouge-style: base16.monokai
:toc:
:icons: font
:license: MIT

====
image::https://github.com/fnf-org/TicketBooth/actions/workflows/rspec.yml/badge.svg[TicketBooth CI: RSpec,link=https://github.com/fnf-org/TicketBooth/actions/workflows/rspec.yml]

image::https://github.com/fnf-org/TicketBooth/actions/workflows/lint.yml/badge.svg[TicketBooth CI: RuboCop,link=https://github.com/fnf-org/TicketBooth/actions/workflows/lint.yml]

image:https://github.com/fnf-org/TicketBooth/actions/workflows/build.yaml/badge.svg[Docker Image Build,link="https://github.com/fnf-org/TicketBooth/actions/workflows/build.yaml"]
====

NOTE: This app is formerly known as **Helping Culture**, which in turn was originally conceived and inspired by Tracy Page. This project was originally written by https://github.com/sds[Shane de Silva]. It is currently maintained by the https://github.com/fnf-org[FnF] org, and within it specifically https://github.com/kigster[Konstantin Gredeskoul] for any application issues, and https://github.com/mike-matera[Mike Matera] for any issues related to deployment to the Google Public Cloud. Please use labels to tag any reported issues.

NOTE: Please see the xref:README.pdf[following link] for a PDF version of this README.

== Welcome to the *Ticket Booth*!

The goal of the app is to make ticket and volunteer management for community events easier and automated.

== Development Environment Setup

The following walks through a local setup on OS-X M1.

=== Streamlined Setup

If you installed https://brew.sh[Homebrew] on your laptop, you should be able to boot the app.

You can run the following setup script to attempt a complete set up of the development environment, as well as the installation of the Rubies, Gems and Database:

[source,bash]
----
bin/boot-up
----

This should automatically open the browser at the `http://localhost:3000` URL, if all the steps succeed.

The `bin/boot-up` script will start the Rails server, or show an error that needs to be fixed.

After you stop it with `Ctrl-C`, you can restart the server using the following shortcut:

[source,bash]
make dev

This actually starts Foreman via `bundle exec foreman -f Procfile.dev` â€” this is required to start CSS and JS just-in-time compilcation in addition to the Rails server. 

CAUTION: Running `rails s` is no longer sufficient to start the application.

==== Running Tests and Linters

To verify that your local environment is working, run the following:

[source,bash]
----
make ci
----

This will run DB Migrations, followed by RSpec, Rubocop, and ShellCheck.

==== Additional Information

We dedicated a separate document to the xref:DEVELOPERS.pdf[developer setup], which helps you get the application running locally.

Alternatively, keep reading for step-by-step manual instructions.


=== Optional Manual Setup

If you prefer to run all the steps manually, then follow the guide below.

==== Manual 1: Services

Please make sure you have PostgreSQL and running locally, or install it via Homebrew:

[source,bash]
----
brew install direnv

brew install postgresql@16
brew services postgresql@16 start

brew install memcached
brew services memcached start
----

==== Manual 2: Direnv Setup

Before you can start the Ruby Server, you need to configure `direnv` so that the environment in the file `.envrc` is loaded on OS-X.

To do that follow the instructions for setting direnv on https://direnv.net/docs/hook.html#bash[bash] or https://direnv.net/docs/hook.html#zsh[zsh] depending on what you are running. To find out, run `echo $SHELL`.

After you setup the shell initialization file, restart your terminal or reload the shell configuration.

Once you are back in the project's folder, run:

[source,bash]
direnv allow .

This will load the environment variables from the `.envrc` file.

==== Manual 3: Ruby Setup

[source,bash]
----
# install brew from https://brew.sh
brew bundle 2>/dev/null

# ensure the following packages exist
brew install rbenv ruby-build direnv volta

eval "$(rbenv init -)"
eval "$(direnv hook ${SHELL/*\/})"

rbenv install -s $(cat .ruby-version)
rbenv local $(cat .ruby-version)
volta install node@lts

bundle install -j 12
rails db:create
rails db:migrate db:seed
rails db:test:prepare

# Run Specs at the end:
bundle exec rspec
----

==== Manual 4: Starting the Server

To start the server post-setup, run:

[source,bash]
----
bin/rails s
# or just
rails s
----

You can also use the `Makefile`:

[source,bash]
----
make development boot
----

Here is an example:

image:docs/make-boot.png["Booting with Make"]

=== Tooling

==== Adding Site Admin

When the database is completely blank, the first step is to create the initial account. Lets say you registered as 'kig@fnf.org':

The second step is to make that person a site admin:

[source,bash]
----
RAILS_ENV=production
bin/site-admin add kig@fnf.org

# Or, to remove site admin from a given user:
bin/site-admin remove kig@fnf.org
----

==== Generating Music Submissions List

The repo contains a convenient script for generating HTML to embed into the Wordpress site, using a CSV generated out of Google Spreadsheet collected using Google Forms.

The CSV must contain three columns and a header row:

 * DJ Name
 * Full Name
 * Set URL

To generate the HTML (we'll use the CSV file checked into the fixtures):

[source,bash]
----
# eg, using the fixture file:
$ bin/music-submission-links spec/fixtures/chill_sets.csv > chill_set.html

# or, to include the simple CSS into the header:
$ bin/music-submission-links spec/fixtures/chill_sets.csv --simple-css > chill_set.html
open chill_set.html
----

====
WARNING: If you add `--simple-css` to the arguments, the generated HTML will include `<head>` element with the https://simplecss.org/[Simple CSS Stylesheet]. Do not use this flag if you plan to paste the output into the WordPress text box. Use this flag if you simply want to verify the resulting HTML in a browser by running `open chill_set.html`.
====

To verify that the script is working and generating correct HTML, you might want to install a handy tool called `bat`, eg using Homebrew on Mac OS-X:

[source,bash]
----
$ brew install bat
$ bin/music-submission-links spec/fixtures/chill_sets.csv | bat
----

===== Adding Submissions to WordPress

Now you can open WordPress, create a two-column layout on the submissions page and paste the contents into one of the two columns, typically:

 1. Night time / Peak Hour
 2. Chill / Daytime

First, let's copy the resulting HTML into clipboard:

[source,bash]
----
$ bin/music-submission-links chill_sets.csv | pbcopy
----

Now we can paste it into WordPress directly.

== API Documentation

Yard-generated documentation is available via running:

[source,bash]
----
$ bundle exec rake doc
# this will automatically open the index.html
----



